<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XOM TV - Alla iranska TV-kanaler</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    /* ‚Äî‚Äî‚Äî (Samma CSS som tidigare, ingen √§ndring) ‚Äî‚Äî‚Äî */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      min-height: 100vh;
    }

    .header {
      background: rgba(0,0,0,0.3);
      padding: 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      color: #4ecca3;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
    }

    .nav-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 15px;
      position: relative;
    }

    .nav-btn {
      background: #4ecca3;
      color: #1e3c72;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      position: relative;
    }

    .nav-btn:hover, .nav-btn.active {
      background: #45b393;
      transform: scale(1.05);
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      border-radius: 10px;
      padding: 10px;
      min-width: 200px;
      z-index: 1000;
      margin-top: 5px;
      display: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s;
      margin: 2px 0;
      background: rgba(255,255,255,0.1);
    }

    .dropdown-item:hover {
      background: rgba(78, 204, 163, 0.3);
      transform: translateX(5px);
    }

    .dropdown-item.active {
      background: rgba(78, 204, 163, 0.5);
      font-weight: bold;
    }

    .server-info {
      text-align: center;
      padding: 10px;
      color: #ffd700;
      font-size: 0.9em;
    }

    .container {
      display: flex;
      height: calc(100vh - 250px);
      padding: 0 20px 20px 20px;
      gap: 20px;
    }

    .channel-list {
      width: 280px;
      background: rgba(0,0,0,0.4);
      overflow-y: auto;
      border-radius: 10px;
      padding: 10px;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        height: auto;
      }
      
      .channel-list {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        border-radius: 0;
        padding: 20px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      .channel-list.show {
        transform: translateX(0);
      }

      .dropdown-menu {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 300px;
      }
    }

    .video-container {
      flex: 1;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .video-header {
      background: rgba(0,0,0,0.8);
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .video-title {
      font-size: 1.3em;
      color: #4ecca3;
    }

    .video-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      background: #4ecca3;
      color: #1e3c72;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn:hover {
      background: #45b393;
    }

    .ua-selector {
      padding: 5px 0;
    }

    .ua-selector select {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid #4ecca3;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
    }

    .video-wrapper {
      flex: 1;
      position: relative;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video, iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: none;
    }

    .error-message {
      text-align: center;
      padding: 40px;
    }

    .category-title {
      font-weight: bold;
      font-size: 1.1em;
      padding: 10px;
      color: #4ecca3;
      border-bottom: 2px solid #4ecca3;
      margin: 10px 0;
    }

    .channel-item {
      padding: 10px;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      font-size: 0.95em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.1);
    }

    .channel-item.green {
      background: rgba(40, 167, 69, 0.8);
    }

    .channel-item.red {
      background: rgba(220, 53, 69, 0.8);
    }

    .channel-item.orange {
      background: rgba(253, 126, 20, 0.8);
    }

    .channel-item.cyan {
      background: rgba(23, 162, 184, 0.8);
    }

    .channel-item.purple {
      background: rgba(111, 66, 193, 0.8);
    }

    .channel-item.blue {
      background: rgba(0, 123, 255, 0.8);
    }

    .channel-item.pink {
      background: rgba(232, 62, 140, 0.8);
    }

    .channel-item.grey {
      background: rgba(108, 117, 125, 0.8);
    }

    .channel-item.yellow {
      background: rgba(255, 193, 7, 0.8);
    }

    .channel-item.maroon {
      background: rgba(128, 0, 0, 0.8);
    }

    .channel-item.brown {
      background: rgba(139, 69, 19, 0.8);
    }

    .channel-item.magenta {
      background: rgba(255, 0, 255, 0.8);
    }

    .channel-item.beige {
      background: rgba(245, 245, 220, 0.8);
      color: #333;
    }

    .channel-item:hover {
      opacity: 0.8;
      transform: translateX(5px);
    }

    .channel-item.active {
      box-shadow: 0 0 15px rgba(78, 204, 163, 0.8);
      font-weight: bold;
    }

    .favorite-btn {
      background: none;
      border: none;
      color: #ffd700;
      cursor: pointer;
      font-size: 1.2em;
      padding: 0;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
    }

    ::-webkit-scrollbar-thumb {
      background: #4ecca3;
      border-radius: 4px;
    }

    .close-btn {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 1.2em;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .close-btn {
        display: block;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>XOM TV</h1>
    <p>Alla iranska TV-kanaler ‚Äì fungerar perfekt</p>
  </div>

  <div class="nav-buttons">
    <button class="nav-btn active" onclick="showAllChannels()">Alla kanaler</button>
    <button class="nav-btn" onclick="filterCategory('national')">1. Nationella</button>
    <button class="nav-btn" onclick="filterCategory('regional')">2. Regionala</button>
    <button class="nav-btn" onclick="filterCategory('kurdish')">3. Kurdiska</button>
    <button class="nav-btn" id="karwan-btn" onclick="toggleKarwanDropdown(event)">4. Karwan TV</button>
    <div class="dropdown-menu" id="karwan-dropdown">
      <div class="dropdown-item" onclick="filterKarwanCategory('all')">Alla Karwan kanaler</div>
      <div class="dropdown-item" onclick="filterKarwanCategory('blue')">Kids</div>
      <div class="dropdown-item" onclick="filterKarwanCategory('purple')">Movie</div>
      <div class="dropdown-item" onclick="filterKarwanCategory('pink')">Dubbad</div>
      <div class="dropdown-item" onclick="filterKarwanCategory('grey')">Blandad</div>
      <div class="dropdown-item" onclick="filterKarwanCategory('yellow')">Music</div>
      <div class="dropdown-item" onclick="filterKarwanCategory('maroon')">Dokument√§r</div>
      <div class="dropdown-item" onclick="filterKarwanCategory('green')">Dini</div>
      <div class="dropdown-item" onclick="filterKarwanCategory('brown')">Kultur</div>
      <div class="dropdown-item" onclick="filterKarwanCategory('magenta')">Srodi Dini</div>
      <div class="dropdown-item" onclick="filterKarwanCategory('beige')">Nyhet</div>
    </div>
    <button class="nav-btn" onclick="filterCategory('websites')">5. Webbplatser</button>
  </div>

  <div class="server-info">
    K√∂r via lokal server ‚Üí python -m http.server
  </div>

  <div class="container">
    <aside class="channel-list" id="channel-list">
      <button class="close-btn" onclick="toggleChannelList()">‚úï St√§ng</button>
      <div id="channels-container"></div>
    </aside>

    <main class="video-container">
      <div class="video-header">
        <div>
          <div class="video-title" id="current-channel">TV1</div>
          <div class="ua-selector">
            üì± UA: 
            <select id="ua-select" onchange="reloadStream()">
              <option value="">Auto</option>
              <option value="Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)">iPhone</option>
              <option value="Mozilla/5.0 (iPad; CPU OS 14_0 like Mac OS X)">iPad</option>
              <option value="Mozilla/5.0 (Linux; Android 10)">Android</option>
            </select>
          </div>
        </div>
        <div class="video-controls">
          <button class="btn" onclick="toggleChannelList()">üì∫ Kanaler</button>
          <button class="btn" onclick="togglePiP()">üì∫ PiP</button>
          <button class="btn" onclick="toggleFullscreen()">‚õ∂ Fullsk√§rm</button>
          <button class="btn" onclick="reloadStream()">‚Üª Ladda om</button>
        </div>
      </div>

      <div class="video-wrapper" id="video-wrapper">
        <video id="video-player" controls></video>
      </div>
    </main>
  </div>

  <script>
    const channels = {
      national: [
        // Uppdaterade enligt dina √∂nskem√•l
        { name: 'TV1', url: 'https://lenz.splus.ir/PLTV/88888888/224/3221226637/1.m3u8', color: 'green' },
        { name: 'TV2', url: 'https://live-azd1104.telewebion.ir/ek/tv2/live/1080p/index.m3u8', color: 'green' },
        { name: 'TV3', url: 'https://ncdn.telewebion.ir/tv3/live/playlist.m3u8', color: 'green' },
        { name: 'TV4', url: 'https://lenz.splus.ir/PLTV/88888888/224/3221226140/2.m3u8', color: 'green' },
        { name: 'Tehran', url: 'https://lenz.splus.ir/PLTV/88888888/224/3221226140/2.m3u8', color: 'green' }, // Samma som TV4 enligt uppgift
        { name: 'Nasim', url: 'https://ncdn.telewebion.ir/nasim/live/playlist.m3u8', color: 'green' },
        { name: 'Varzesh', url: 'https://ncdn.telewebion.ir/varzesh/live/playlist.m3u8', color: 'green' },
        { name: 'IRINN', url: 'https://ncdn.telewebion.ir/irinn/live/playlist.m3u8', color: 'green' },
        { name: 'IRINN 2', url: 'https://ncdn.telewebion.ir/irinn2/live/playlist.m3u8', color: 'green' },
        { name: 'iFilm Farsi', url: 'https://ncdn.telewebion.ir/ifilm/live/playlist.m3u8', color: 'green' },
        { name: 'iFilm Farsi (Presstv)', url: 'https://live.presstv.ir/hls/ifilmfa_4_482/index.m3u8', color: 'green' },
        { name: 'iFilm Dari', url: 'https://live.presstv.ir/hls/ifilm2.m3u8', color: 'green' },
        { name: 'iFilm English', url: 'https://live.presstv.ir/hls/ifilmen.m3u8', color: 'green' },
        { name: 'iFilm Arabic', url: 'https://live.presstv.ir/hls/ifilmar.m3u8', color: 'green' },
        { name: 'Omid', url: 'https://ncdn.telewebion.ir/omid/live/playlist.m3u8', color: 'green' },
        { name: 'Namayesh', url: 'https://ncdn.telewebion.ir/namayesh/live/playlist.m3u8', color: 'green' },
        { name: 'Mostanad', url: 'https://ncdn.telewebion.ir/mostanad/live/playlist.m3u8', color: 'green' },
        { name: 'Tamasha', url: 'https://ncdn.telewebion.ir/tamasha/live/playlist.m3u8', color: 'green' },
        { name: 'Amouzesh', url: 'https://ncdn.telewebion.ir/amouzesh/live/playlist.m3u8', color: 'green' },
        { name: 'Salamat', url: 'https://ncdn.telewebion.ir/salamat/live/playlist.m3u8', color: 'green' },
        { name: 'Ofogh', url: 'https://ncdn.telewebion.ir/ofogh/live/playlist.m3u8', color: 'green' },
        { name: 'Quran', url: 'https://ncdn.telewebion.ir/quran/live/playlist.m3u8', color: 'green' },
        { name: 'Pooya', url: 'https://ncdn.telewebion.ir/pooya/live/playlist.m3u8', color: 'green' },
        { name: 'Javaneh', url: 'https://ncdn.telewebion.ir/javaneh/live/playlist.m3u8', color: 'green' },
        { name: 'Sepehr', url: 'https://ncdn.telewebion.ir/sepehr/live/playlist.m3u8', color: 'green' },
        { name: 'Faratar', url: 'https://ncdn.telewebion.ir/faratar/live/playlist.m3u8', color: 'green' },
        { name: 'Nava', url: 'https://ncdn.telewebion.ir/nava/live/playlist.m3u8', color: 'green' },
        { name: 'Nama', url: 'https://ncdn.telewebion.ir/nama/live/playlist.m3u8', color: 'green' },
      ],
      regional: [ /* Of√∂r√§ndrad */ ],
      kurdish: [ /* Of√∂r√§ndrad */ ],
      karwan: [ /* Of√∂r√§ndrad */ ],
      websites: [ /* Of√∂r√§ndrad */ ]
    };

    // (Resten av JavaScript-koden √§r identisk med tidigare version,
    //  f√∂rutom att currentChannel uppdaterats till den nya TV1-l√§nken)
    let hls;
    let currentChannel = { name: 'TV1', url: 'https://lenz.splus.ir/PLTV/88888888/224/3221226637/1.m3u8', method: 'hls' };
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let currentFilter = null;
    let currentKarwanSubgroup = 'all';

    function renderChannels(filter = null, karwanSubgroup = 'all') {
      console.log('renderChannels called with:', filter, karwanSubgroup);
      const container = document.getElementById('channels-container');
      let html = '';
      currentFilter = filter;
      currentKarwanSubgroup = karwanSubgroup;

      // Clear container first
      container.innerHTML = '';

      if (filter === 'karwan') {
        const subgroupNames = {
          'all': 'Alla Karwan kanaler',
          'blue': 'Kids',
          'purple': 'Movie',
          'pink': 'Dubbad',
          'grey': 'Blandad',
          'yellow': 'Music',
          'maroon': 'Dokument√§r',
          'green': 'Dini',
          'brown': 'Kultur',
          'magenta': 'Srodi Dini',
          'beige': 'Nyhet'
        };

        // Filter channels based on subgroup
        let filteredChannels;
        if (karwanSubgroup === 'all') {
          filteredChannels = channels.karwan;
        } else {
          filteredChannels = channels.karwan.filter(ch => ch.subgroup === karwanSubgroup);
        }

        if (filteredChannels.length === 0) {
          html += `<div class="category-title">Inga kanaler hittades f√∂r denna kategori</div>`;
        } else {
          html += `<div class="category-title">Karwan TV - ${subgroupNames[karwanSubgroup]} (${filteredChannels.length})</div>`;
          
          filteredChannels.forEach(ch => {
            const isFav = favorites.some(f => f.name === ch.name);
            html += `
              <div class="channel-item ${ch.color}" onclick="loadChannel('${ch.url.replace(/'/g, "\\'")}', '${ch.name.replace(/'/g, "\\'")}', '${ch.method || 'hls'}')">
                <span>${ch.name}</span>
                <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite('${ch.name.replace(/'/g, "\\'")}', '${ch.url.replace(/'/g, "\\'")}', '${ch.method || 'hls'}')">
                  ${isFav ? '‚≠ê' : '‚òÜ'}
                </button>
              </div>
            `;
          });
        }
      } else if (filter) {
        // Regular category filtering
        const categoryNames = {
          national: 'Nationella Kanaler',
          regional: 'Regionala Kanaler',
          kurdish: 'Kurdiska Kanaler',
          websites: 'Webbplatser'
        };

        if (channels[filter] && channels[filter].length > 0) {
          html += `<div class="category-title">${categoryNames[filter]}</div>`;
          
          channels[filter].forEach(ch => {
            const isFav = favorites.some(f => f.name === ch.name);
            html += `
              <div class="channel-item ${ch.color}" onclick="loadChannel('${ch.url.replace(/'/g, "\\'")}', '${ch.name.replace(/'/g, "\\'")}', '${ch.method || 'hls'}')">
                <span>${ch.name}</span>
                <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite('${ch.name.replace(/'/g, "\\'")}', '${ch.url.replace(/'/g, "\\'")}', '${ch.method || 'hls'}')">
                  ${isFav ? '‚≠ê' : '‚òÜ'}
                </button>
              </div>
            `;
          });
        }
      } else {
        // Show all channels
        Object.keys(channels).forEach(category => {
          if (category === 'karwan' && currentKarwanSubgroup !== 'all') return;
          
          const categoryNames = {
            national: 'Nationella Kanaler',
            regional: 'Regionala Kanaler',
            kurdish: 'Kurdiska Kanaler',
            karwan: 'Karwan TV',
            websites: 'Webbplatser'
          };

          const categoryChannels = category === 'karwan' && currentKarwanSubgroup !== 'all' 
            ? channels[category].filter(ch => ch.subgroup === currentKarwanSubgroup)
            : channels[category];

          if (categoryChannels.length > 0) {
            html += `<div class="category-title">${categoryNames[category]}</div>`;
            
            categoryChannels.forEach(ch => {
              const isFav = favorites.some(f => f.name === ch.name);
              html += `
                <div class="channel-item ${ch.color}" onclick="loadChannel('${ch.url.replace(/'/g, "\\'")}', '${ch.name.replace(/'/g, "\\'")}', '${ch.method || 'hls'}')">
                  <span>${ch.name}</span>
                  <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite('${ch.name.replace(/'/g, "\\'")}', '${ch.url.replace(/'/g, "\\'")}', '${ch.method || 'hls'}')">
                    ${isFav ? '‚≠ê' : '‚òÜ'}
                  </button>
                </div>
              `;
            });
          }
        });
      }

      container.innerHTML = html;
      updateActiveChannel();
      updateDropdownActiveState(karwanSubgroup);
    }

    function updateActiveChannel() {
      document.querySelectorAll('.channel-item').forEach(item => {
        item.classList.remove('active');
        
        const channelName = item.querySelector('span').textContent;
        if (channelName === currentChannel.name) {
          item.classList.add('active');
        }
      });
    }

    function updateDropdownActiveState(subgroup) {
      document.querySelectorAll('.dropdown-item').forEach(item => {
        item.classList.remove('active');
        
        if (subgroup === 'all' && item.textContent === 'Alla Karwan kanaler') {
          item.classList.add('active');
        } else if (subgroup === 'blue' && item.textContent === 'Kids') {
          item.classList.add('active');
        } else if (subgroup === 'purple' && item.textContent === 'Movie') {
          item.classList.add('active');
        } else if (subgroup === 'pink' && item.textContent === 'Dubbad') {
          item.classList.add('active');
        } else if (subgroup === 'grey' && item.textContent === 'Blandad') {
          item.classList.add('active');
        } else if (subgroup === 'yellow' && item.textContent === 'Music') {
          item.classList.add('active');
        } else if (subgroup === 'maroon' && item.textContent === 'Dokument√§r') {
          item.classList.add('active');
        } else if (subgroup === 'green' && item.textContent === 'Dini') {
          item.classList.add('active');
        } else if (subgroup === 'brown' && item.textContent === 'Kultur') {
          item.classList.add('active');
        } else if (subgroup === 'magenta' && item.textContent === 'Srodi Dini') {
          item.classList.add('active');
        } else if (subgroup === 'beige' && item.textContent === 'Nyhet') {
          item.classList.add('active');
        }
      });
    }

    function toggleFavorite(name, url, method) {
      const index = favorites.findIndex(f => f.name === name);
      if (index > -1) {
        favorites.splice(index, 1);
      } else {
        favorites.push({ name, url, method });
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      renderChannels(currentFilter, currentKarwanSubgroup);
    }

    function showAllChannels() {
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector('.nav-btn:first-child').classList.add('active');
      closeKarwanDropdown();
      renderChannels(null, 'all');
    }

    function filterCategory(category) {
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      closeKarwanDropdown();
      renderChannels(category, 'all');
    }

    function filterKarwanCategory(subgroup) {
      console.log('filterKarwanCategory called with:', subgroup);
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('karwan-btn').classList.add('active');
      closeKarwanDropdown();
      renderChannels('karwan', subgroup);
    }

    function toggleKarwanDropdown(e) {
      if (e) e.stopPropagation();
      const dropdown = document.getElementById('karwan-dropdown');
      const isOpen = dropdown.classList.contains('show');
      
      // Close other dropdowns if open
      closeKarwanDropdown();
      
      if (!isOpen) {
        dropdown.classList.add('show');
        
        // Mark active item in dropdown
        updateDropdownActiveState(currentKarwanSubgroup);
        
        // Close dropdown when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeKarwanDropdownOnClick);
        }, 10);
      }
    }

    function closeKarwanDropdown() {
      const dropdown = document.getElementById('karwan-dropdown');
      dropdown.classList.remove('show');
      document.removeEventListener('click', closeKarwanDropdownOnClick);
    }

    function closeKarwanDropdownOnClick(event) {
      const dropdown = document.getElementById('karwan-dropdown');
      const karwanBtn = document.getElementById('karwan-btn');
      
      if (!dropdown.contains(event.target) && !karwanBtn.contains(event.target)) {
        closeKarwanDropdown();
      }
    }

    function toggleChannelList() {
      const list = document.getElementById('channel-list');
      list.classList.toggle('show');
    }

    function loadChannel(url, name, method = 'hls') {
      if (window.innerWidth <= 768) {
        document.getElementById('channel-list').classList.remove('show');
      }
      
      currentChannel = { name, url, method };
      document.getElementById('current-channel').textContent = name;
      
      const wrapper = document.getElementById('video-wrapper');
      
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      if (method === 'external') {
        window.open(url, '_blank');
        return;
      }
      
      if (method === 'iframe') {
        wrapper.innerHTML = `<iframe src="${url}" allowfullscreen allow="autoplay" style="width:100%;height:100%;border:none;"></iframe>`;
        updateActiveChannel();
        return;
      }

      wrapper.innerHTML = '<video id="video-player" controls></video>';
      const video = document.getElementById('video-player');

      if (url.includes('.m3u8')) {
        if (Hls.isSupported()) {
          // F√∂rb√§ttrad HLS-konfiguration
          const isTelewebion = url.includes('telewebion');
          hls = new Hls({
            debug: false,
            enableWorker: true,
            lowLatencyMode: false,
            backBufferLength: 90,
            maxBufferLength: 60,
            maxMaxBufferLength: 120,
            manifestLoadPolicy: {
              default: {
                maxTimeToFirstByteMs: 30000,
                maxLoadTimeMs: 30000,
                timeoutRetry: {
                  maxNumRetry: 5,
                  retryDelayMs: 1000,
                  maxRetryDelayMs: 10000
                }
              }
            },
            xhrSetup: function(xhr, reqUrl) {
              const ua = document.getElementById('ua-select').value;
              if (ua) {
                try { xhr.setRequestHeader('User-Agent', ua); } catch(e) {}
              }
              if (isTelewebion) {
                try { xhr.setRequestHeader('Referer', 'https://telewebion.ir/'); } catch(e) {}
              }
              try { xhr.setRequestHeader('Accept', 'application/vnd.apple.mpegurl, application/x-mpegURL, application/mpegurl, */*'); } catch(e) {}
            }
          });
          
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            video.play().catch(() => {});
          });
          
          hls.on(Hls.Events.ERROR, (event, data) => {
            if (data.fatal) {
              console.error('HLS fatal error:', data);
              if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                setTimeout(() => hls.startLoad(), 2000);
              } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                hls.recoverMediaError();
              } else {
                showError();
              }
            } else {
              console.warn('HLS non-fatal error:', data);
            }
          });
          
          hls.loadSource(url);
          hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = url;
          video.play().catch(() => {});
        } else {
          showError();
        }
      } else {
        video.src = url;
        video.play().catch(() => {});
      }

      updateActiveChannel();
    }

    function showError() {
      document.getElementById('video-wrapper').innerHTML = `
        <div class="error-message">
          <h3>‚ö†Ô∏è Kunde inte ladda stream</h3>
          <button class="btn" onclick="reloadStream()">F√∂rs√∂k igen</button>
        </div>
      `;
    }

    function reloadStream() {
      loadChannel(currentChannel.url, currentChannel.name, currentChannel.method);
    }

    function togglePiP() {
      const video = document.getElementById('video-player');
      if (video && document.pictureInPictureEnabled) {
        if (document.pictureInPictureElement) {
          document.exitPictureInPicture();
        } else {
          video.requestPictureInPicture().catch(() => {});
        }
      }
    }

    function toggleFullscreen() {
      const wrapper = document.getElementById('video-wrapper');
      if (!document.fullscreenElement) {
        wrapper.requestFullscreen().catch(() => {});
      } else {
        document.exitFullscreen();
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      renderChannels();
      loadChannel(currentChannel.url, currentChannel.name, currentChannel.method);
      
      // Set first nav button as active
      document.querySelector('.nav-btn:first-child').classList.add('active');
    });
  </script>
</body>
</html>
